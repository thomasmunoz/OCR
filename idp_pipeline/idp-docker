#!/bin/bash
#═══════════════════════════════════════════════════════════════════════════════
# IDP PIPELINE - DOCKER CONTROL
# One command to rule them all
#═══════════════════════════════════════════════════════════════════════════════
# Usage:
#   ./idp-docker              # Start (1 worker)
#   ./idp-docker up           # Start (1 worker)
#   ./idp-docker up 3         # Start with 3 workers
#   ./idp-docker down         # Stop all
#   ./idp-docker status       # Show status
#   ./idp-docker logs         # Show logs
#   ./idp-docker scale 5      # Scale to 5 workers
#   ./idp-docker gpu          # Start with GPU support
#═══════════════════════════════════════════════════════════════════════════════

set -e

DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
banner() {
    echo -e "${PURPLE}"
    echo "╔═══════════════════════════════════════════════════════════════╗"
    echo "║     _____ _____  _____    _____ _            _ _              ║"
    echo "║    |_   _|  __ \|  __ \  |  __ (_)          | (_)             ║"
    echo "║      | | | |  | | |__) | | |__) | _ __   ___| |_ _ __   ___   ║"
    echo "║      | | | |  | |  ___/  |  ___/ | '_ \ / _ \ | | '_ \ / _ \  ║"
    echo "║     _| |_| |__| | |      | |   | | |_) |  __/ | | | | |  __/  ║"
    echo "║    |_____|_____/|_|      |_|   |_| .__/ \___|_|_|_| |_|\___|  ║"
    echo "║                                  | |                          ║"
    echo "║                                  |_|  100% On-Premise          ║"
    echo "╚═══════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Check Docker
check_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}Error: Docker is not installed${NC}"
        echo "Install Docker: https://docs.docker.com/get-docker/"
        exit 1
    fi
    if ! docker info &> /dev/null; then
        echo -e "${RED}Error: Docker daemon is not running${NC}"
        exit 1
    fi
}

# Start services
start() {
    local workers=${1:-1}
    local gpu=${2:-false}

    echo -e "${CYAN}Starting IDP Pipeline with ${workers} worker(s)...${NC}"

    if [ "$gpu" = true ]; then
        echo -e "${YELLOW}GPU mode enabled${NC}"
        docker compose -f docker-compose.gpu.yml up -d --build --scale worker-gpu=$workers
    else
        docker compose up -d --build --scale worker=$workers
    fi

    echo ""
    echo -e "${GREEN}✅ IDP Pipeline started!${NC}"
    echo ""
    echo -e "   ${CYAN}Dashboard:${NC}  http://localhost:8080"
    echo -e "   ${CYAN}API:${NC}        http://localhost:8080/api"
    echo -e "   ${CYAN}Health:${NC}     http://localhost:8080/health"
    echo ""
    echo -e "   ${YELLOW}Scale workers:${NC}  ./idp-docker scale <N>"
    echo -e "   ${YELLOW}View logs:${NC}      ./idp-docker logs"
    echo -e "   ${YELLOW}Stop:${NC}           ./idp-docker down"

    # Open browser on macOS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sleep 3
        open "http://localhost:8080"
    fi
}

# Stop services
stop() {
    echo -e "${CYAN}Stopping IDP Pipeline...${NC}"
    docker compose down 2>/dev/null || true
    docker compose -f docker-compose.gpu.yml down 2>/dev/null || true
    echo -e "${GREEN}✅ Stopped${NC}"
}

# Show status
status() {
    echo -e "${CYAN}IDP Pipeline Status${NC}"
    echo ""
    docker compose ps 2>/dev/null || echo "Not running (standard mode)"
    echo ""

    # Check health
    if curl -s http://localhost:8080/health > /dev/null 2>&1; then
        echo -e "${GREEN}✅ API: Healthy${NC}"
        curl -s http://localhost:8080/health | python3 -m json.tool 2>/dev/null || true
    else
        echo -e "${RED}❌ API: Not responding${NC}"
    fi
}

# Scale workers
scale() {
    local workers=${1:-1}
    echo -e "${CYAN}Scaling to ${workers} workers...${NC}"

    # Check if GPU compose is running
    if docker compose -f docker-compose.gpu.yml ps 2>/dev/null | grep -q "worker-gpu"; then
        docker compose -f docker-compose.gpu.yml up -d --scale worker-gpu=$workers --no-recreate
    else
        docker compose up -d --scale worker=$workers --no-recreate
    fi

    echo -e "${GREEN}✅ Scaled to ${workers} workers${NC}"
}

# Show logs
logs() {
    local service=${1:-""}
    if [ -n "$service" ]; then
        docker compose logs -f $service
    else
        docker compose logs -f
    fi
}

# Build images
build() {
    echo -e "${CYAN}Building IDP Pipeline images...${NC}"
    docker compose build
    echo -e "${GREEN}✅ Build complete${NC}"
}

# Pull models
pull_models() {
    echo -e "${CYAN}Downloading recommended AI models...${NC}"
    docker compose run --rm api python run.py download
    echo -e "${GREEN}✅ Models downloaded${NC}"
}

# Clean up
clean() {
    echo -e "${YELLOW}Cleaning up...${NC}"
    docker compose down -v --remove-orphans 2>/dev/null || true
    docker compose -f docker-compose.gpu.yml down -v --remove-orphans 2>/dev/null || true
    echo -e "${GREEN}✅ Cleaned${NC}"
}

# Main
banner
check_docker

case "${1:-up}" in
    up|start)
        start "${2:-1}" false
        ;;
    gpu)
        start "${2:-1}" true
        ;;
    down|stop)
        stop
        ;;
    restart)
        stop
        sleep 2
        start "${2:-1}"
        ;;
    status|ps)
        status
        ;;
    scale)
        scale "${2:-1}"
        ;;
    logs)
        logs "$2"
        ;;
    build)
        build
        ;;
    models|pull-models)
        pull_models
        ;;
    clean)
        clean
        ;;
    *)
        echo "IDP Pipeline - Docker Control"
        echo ""
        echo "Usage: ./idp-docker [command] [options]"
        echo ""
        echo "Commands:"
        echo "  up [N]        Start with N workers (default: 1)"
        echo "  gpu [N]       Start with GPU support and N workers"
        echo "  down          Stop all services"
        echo "  restart [N]   Restart with N workers"
        echo "  status        Show service status"
        echo "  scale N       Scale to N workers"
        echo "  logs [svc]    Show logs (optional: api, worker, redis)"
        echo "  build         Build Docker images"
        echo "  models        Download AI models"
        echo "  clean         Remove all containers and volumes"
        echo ""
        echo "Examples:"
        echo "  ./idp-docker              # Start with 1 worker"
        echo "  ./idp-docker up 3         # Start with 3 workers"
        echo "  ./idp-docker gpu 2        # Start with 2 GPU workers"
        echo "  ./idp-docker scale 5      # Scale to 5 workers"
        ;;
esac
